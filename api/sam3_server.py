from sam3_segments import sam3_segment_image, process_segments_and_save, embed_segment_images

import requests
import os
from urllib.parse import urlparse
from fastapi import FastAPI, HTTPException, Query
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List
from contextlib import asynccontextmanager
import psycopg2
from psycopg2 import pool
from dotenv import load_dotenv
import sys
import os

load_dotenv()

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from database.Direct_connection import search_by_voyage_embedding


mock_embedding = [-0.03112793, 0.02746582, 0.046875, -0.000141144, -0.022949219, -0.003570557, 0.013671875, 0.045898438, 0.040283203, 
-0.012207031, -0.022216797, 0.008422852, 0.014282227, -0.008178711, 0.021362305, -0.001464844, 0.04711914, -0.012329102, 
-0.032714844, -0.035888672, -0.007995605, 0.007598877, 0.003128052, 0.06225586, -0.076660156, 0.03112793, 0.018798828, -0.03564453, 
-0.022705078, 0.011352539, 0.10888672, 0.046875, -0.04663086, -0.053222656, -0.00176239, 0.024658203, 0.045898438, 0.0234375, 
-0.013671875, 0.011962891, -0.0546875, -0.015991211, -0.013305664, 0.022705078, 0.008789062, 0.014770508, -0.05102539, 0.024414062, 
0.020874023, 0.052001953, 0.015380859, 0.037109375, -0.003585815, 0.041503906, -0.010681152, -0.016601562, 0.0234375, -0.08203125, 
-0.03930664, -0.00604248, 0.072265625, -0.03540039, -0.041259766, 0.017822266, -0.000107288, -0.033447266, 0.037841797, 0.006439209, 
-0.002319336, -7.6771e-05, -0.012573242, -0.006866455, 0.033203125, -0.005859375, -0.003417969, 0.001647949, -0.010192871, 
-0.007354736, -0.026855469, 0.03564453, 0.001625061, -0.005950928, -0.036132812, -0.01940918, -0.019897461, 0.016235352, 
-0.031982422, 0.05053711, 0.011047363, 0.019165039, 0.015991211, 0.003845215, 0.005065918, -0.020141602, -0.009155273, 0.018798828, 
0.006378174, 0.015136719, 0.000598907, -0.018310547, -0.06640625, 0.025634766, 0.023925781, -0.007781982, -0.025634766, 0.03857422, 
-0.010559082, -0.021118164, 0.007385254, -0.002426147, -0.018554688, 0.006530762, 0.028930664, 0.007141113, -0.024169922, 
-0.021362305, 0.031982422, 0.036132812, 0.04272461, -0.03491211, -0.034423828, -0.0703125, 0.041503906, -0.02746582, 0.045166016, 
0.008483887, -0.05102539, 0.016845703, -0.004364014, 0.039794922, -0.023071289, -0.08203125, -0.043701172, -0.023803711, 0.040771484, 
0.059814453, 0.05883789, 0.035888672, 0.00176239, 0.03466797, 0.034179688, -0.037109375, -0.007049561, 0.048828125, 0.004638672, 
0.016235352, -0.045410156, 0.00958252, 0.005462646, 0.026123047, 0.006835938, -0.047607422, -0.013244629, -0.068359375, -0.005096436, 
0.041748047, 0.047851562, 0.055419922, -0.008117676, -0.020751953, 0.017944336, -0.017456055, -0.028198242, 0.032714844, 0.05908203, 
-0.002166748, 0.03491211, 0.000587463, -0.039794922, -0.018798828, -0.08300781, 0.051513672, 0.025146484, -0.032714844, 0.02746582, 
-0.016235352, -0.11279297, -0.000339508, 0.018066406, -0.008178711, -0.036132812, 0.00567627, -0.0025177, -0.00982666, -0.04248047, 
0.017822266, -0.00692749, 0.037597656, -0.014282227, 0.014282227, 0.04321289, -0.018066406, -0.088378906, 0.004150391, -0.002349854, 
0.030761719, 0.044189453, -0.001541138, -0.016967773, 0.033691406, 0.08300781, 0.014709473, -0.001281738, 0.030273438, 0.000259399, 
-0.017578125, 0.034423828, 0.029541016, -0.001899719, 0.001060486, 0.056152344, -0.020385742, 0.029052734, -0.029907227, 0.04321289, 
-0.007598877, 0.018798828, -0.00491333, -0.033447266, 0.016967773, 0.052001953, -0.0234375, 0.040283203, 0.018554688, -0.05029297, 
-0.013671875, 0.03930664, 0.015197754, -0.015380859, 0.04272461, -0.003631592, -0.037597656, -0.009277344, 0.000261307, -0.003143311, 
-0.041259766, -0.012329102, 0.00994873, -0.0234375, 0.012634277, -0.011779785, -0.014099121, 0.024658203, -0.006439209, 0.028686523, 
-0.002288818, 0.033691406, -0.002243042, -0.025146484, -0.003143311, -0.053955078, 0.0025177, -0.003326416, -0.07714844, 0.006408691, 
-0.048583984, -0.017944336, -0.026123047, 0.011474609, 0.001594543, 0.005737305, 0.028686523, 0.011657715, -0.05908203, -0.036621094, 
-0.044433594, 0.04248047, -0.020874023, 0.013916016, 0.020263672, -0.020141602, 0.001350403, 0.005981445, -0.032470703, 0.021362305, 
-0.028198242, -0.012207031, 0.057128906, -0.012329102, 0.002868652, 0.029052734, -0.05053711, 0.00378418, -0.002639771, -0.029541016, 
0.04711914, 0.029418945, 0.026123047, 0.008300781, 0.014343262, -0.034423828, 0.04663086, 0.020874023, 0.01385498, -0.033447266, 
-0.011230469, 0.022949219, -0.020141602, -0.03125, 0.023803711, -0.03125, -0.037841797, -0.025024414, 0.006317139, -0.032470703, 
-0.026000977, 0.017456055, -0.005523682, 0.04321289, -0.00994873, -0.015563965, -0.014282227, 0.007019043, 0.01586914, -0.03466797, 
-0.005859375, -0.060546875, -0.006744385, -0.012084961, 0.056396484, 0.024414062, 0.00994873, 0.019897461, -0.015625, 0.0078125, 
-0.04248047, 0.03125, 0.026489258, 0.049316406, -0.016357422, 0.02331543, 0.045410156, 0.000352859, 0.002380371, -0.004699707, 
-0.03515625, -0.041015625, -0.017822266, 0.005889893, -0.005340576, 0.00390625, -0.028564453, 0.028686523, 0.013183594, 0.012329102, 
0.02746582, -0.010864258, 0.026000977, -0.02355957, -0.035888672, -0.055419922, 0.012573242, 0.00352478, 0.001899719, 0.028198242, 
-0.026000977, 0.033203125, 0.037109375, -0.000747681, 0.067871094, -0.003845215, -0.040527344, -0.026611328, -0.03930664, 
-0.000183105, -0.004272461, 0.007232666, -0.03857422, 0.052001953, -0.022094727, -0.07519531, 0.052001953, -0.022705078, 
-0.009155273, 0.009033203, -0.09375, 0.02746582, -0.016601562, -0.026489258, 0.008178711, 0.04321289, -0.021728516, 0.044189453, 
0.047851562, -0.002426147, 0.006256104, 0.040771484, -0.020385742, 0.000204086, -0.02355957, 0.03149414, -0.09082031, -0.03515625, 
0.044189453, 0.024169922, -0.020874023, -0.01586914, 0.004516602, 0.0234375, 0.011047363, 0.034423828, -0.049316406, 0.011047363, 
-0.0234375, -0.016601562, -0.04272461, 0.047851562, -0.006652832, -0.020141602, 0.021118164, -0.013671875, 0.008300781, 0.06982422, 
-0.008666992, -0.007995605, -0.05126953, 0.04321289, 0.041259766, 0.061035156, -0.021118164, -0.008178711, -0.05493164, 0.056396484, 
-0.017211914, 0.084472656, 0.001998901, -0.07421875, 0.06933594, 0.03149414, -0.037597656, -0.048583984, 0.027709961, 0.020385742, 
0.021728516, 0.02722168, -0.014831543, -0.000648499, -0.01928711, 0.03491211, 0.015563965, -0.0050354, -0.007995605, 0.029541016, 
0.004455566, -0.020263672, 0.006835938, 0.016601562, -0.017333984, -0.011657715, 0.03515625, -0.012573242, 0.05053711, 0.033203125, 
-0.0234375, -0.05810547, -0.007232666, -0.08691406, 0.01586914, -0.004089355, 0.014038086, 0.05053711, 0.033203125, 0.036621094, 
-0.036621094, -0.023925781, -0.006408691, -0.002258301, 0.026611328, -0.000961304, -0.01940918, -0.005645752, -0.020141602, 
0.022705078, -0.00340271, -0.048828125, -0.011657715, 0.01373291, 0.005432129, -0.04296875, -0.009643555, -0.002975464, 0.045410156, 
0.0050354, 0.013427734, 0.015991211, -0.006317139, 0.044921875, 0.023925781, -0.05126953, 0.053955078, 0.033691406, -0.01928711, 
-0.019165039, -0.015197754, 0.014526367, -0.008544922, 0.010925293, 0.01348877, 0.006103516, 0.021118164, -0.017822266, -0.00994873, 
0.026489258, 0.0078125, 0.018310547, 0.002258301, 0.033203125, 0.03173828, -0.022583008, 0.007415771, 0.009643555, 0.008422852, 
0.002838135, -0.0234375, -0.05126953, 0.0234375, 0.024414062, -0.008422852, -0.038330078, 0.10107422, 0.041748047, 0.008850098, 
-0.039794922, 0.03173828, 0.044921875, -0.006652832, 0.056396484, 0.028076172, -0.037597656, -0.07714844, -0.010925293, -0.061035156, 
0.011047363, 0.03125, -0.014709473, 0.022094727, -0.014953613, 0.072265625, 0.017822266, -0.017333984, 0.026855469, 0.005279541, 
0.029052734, -0.015563965, 0.037597656, 0.032714844, 0.004180908, 0.015136719, 0.028076172, -0.015258789, 0.030273438, 0.017700195, 
0.006195068, -0.03564453, -0.008117676, 0.020141602, -0.004699707, 0.005401611, 0.031982422, 0.005340576, 0.037109375, 0.02734375, 
0.013427734, -0.000659943, -0.000602722, -0.001464844, -0.032714844, 0.05444336, 0.025634766, -0.034179688, 0.026000977, -0.046875, 
-0.002319336, 0.014831543, -0.011352539, -0.021606445, 0.007385254, 0.021362305, 0.017333984, -0.118652344, -0.038330078, 
0.048339844, 0.008300781, -0.002212524, -0.06738281, -0.016845703, 0.002487183, 0.008544922, 0.012145996, 0.026611328, 0.022094727, 
-0.038085938, 0.01928711, 0.006835938, 0.01586914, 0.05029297, -0.019897461, -0.032714844, -0.02331543, -0.037109375, -0.01586914, 
-0.03857422, -0.017578125, -0.001716614, 0.025756836, -0.016845703, 0.026367188, -0.038085938, 0.01928711, -0.011291504, 0.02331543, 
-0.033203125, 0.011047363, 0.012573242, -0.0546875, 0.007415771, -0.029663086, 0.014526367, -0.000421524, -0.028076172, -0.018554688, 
-0.037597656, 0.02734375, 0.00994873, -0.032714844, -0.025634766, 0.009460449, -0.038085938, -0.044921875, 0.00340271, -0.03540039, 
-0.011962891, -0.009033203, -0.037109375, 0.033203125, -0.07080078, 0.068847656, -0.015258789, 0.0234375, 0.038330078, -0.057373047, 
-0.03857422, 0.010803223, 0.018798828, 0.008850098, -0.03930664, 0.033203125, 0.002593994, 0.003326416, 0.014343262, -0.060791016, 
0.030517578, 0.042236328, 0.07324219, 0.001274109, -0.02722168, 0.000402451, 0.040283203, -0.014343262, -0.019042969, 0.057373047, 
0.002929688, 0.022094727, -0.018310547, -0.003631592, 0.033203125, -0.030273438, 0.025024414, 0.010253906, -0.020385742, 
-0.020385742, -0.007995605, -0.025024414, -0.004394531, 0.020874023, -0.013671875, 0.001953125, -0.000850677, -0.025634766, 
-0.017089844, -0.044921875, 0.05493164, -0.005096436, 0.015991211, 0.010803223, -0.00604248, 0.029663086, -0.038085938, 0.01928711, 
0.0703125, 0.005767822, -0.004150391, -0.03491211, -0.001922607, -0.003417969, -0.016845703, -0.021240234, 0.029663086, 0.020507812, 
0.032714844, -0.030395508, 0.044189453, -0.0703125, -0.03515625, -0.048339844, -0.017578125, 0.022460938, -0.075683594, 0.029418945, 
0.006835938, -0.005737305, 0.025268555, -0.0546875, -0.05029297, 0.03930664, -0.03466797, 0.04663086, -0.07128906, 0.040771484, 
0.063964844, 0.044433594, 0.010070801, 0.060546875, 0.007476807, -0.00378418, -0.02355957, -0.022094727, 0.011352539, 0.05883789, 
-0.007263184, 0.042236328, 0.01928711, -0.059326172, 0.033203125, 0.012756348, -0.026611328, -0.05053711, -0.015991211, 0.000448227, 
-0.009643555, 0.046875, -0.021606445, -0.014099121, 0.003616333, 0.022949219, 0.01385498, 0.008666992, 0.014831543, 0.03173828, 
0.028198242, -0.008422852, 0.009521484, 0.029907227, -0.003509521, -0.018310547, -0.017822266, -0.020385742, 0.060791016, 
0.015136719, 0.000274658, -0.088378906, -0.019897461, 0.010803223, -0.012329102, 0.020385742, -0.002243042, -0.008483887, 
0.014526367, 0.07324219, -0.067871094, -0.015991211, 0.042236328, -0.019897461, -0.00970459, 0.000926971, -0.0234375, 0.010620117, 
0.016357422, -0.041748047, -0.052001953, -0.025756836, 0.009521484, -0.014099121, -0.018920898, 0.03491211, -0.046875, 0.020385742, 
-0.003463745, 0.011657715, -0.032714844, 0.003265381, 0.001144409, -0.017333984, 0.00302124, 0.00793457, -0.013671875, -0.040771484, 
0.022094727, 0.038085938, -0.015258789, -0.013671875, 0.033935547, -0.001441956, -0.003997803, -0.017089844, -0.016357422, 
0.001541138, -0.004211426, -0.030273438, -0.00014019, 0.047851562, 0.010375977, 0.071777344, 0.036132812, -0.037109375, -0.037109375, 
-0.004364014, 0.015991211, -0.025756836, 0.033935547, -0.027832031, -0.03125, -0.002975464, 0.008972168, -0.08642578, 0.000591278, 
0.01574707, 0.001403809, 0.00491333, 0.042236328, 0.000747681, -0.014343262, -0.052001953, 0.03881836, 0.003051758, -0.048583984, 
-0.013000488, -0.03564453, -0.030761719, -0.025512695, -0.045898438, -0.036621094, 0.015991211, 0.00680542, -0.016601562, 
0.000253677, -0.024414062, -0.014282227, -0.010803223, 0.011962891, 0.030273438, -0.036132812, -0.028198242, -0.036621094, 
-0.053222656, -0.011047363, 0.007049561, 0.014770508, 0.044433594, 0.008605957, -0.003585815, -0.030395508, -0.022705078, 
0.022705078, -0.008300781, 0.030761719, -0.0078125, -0.003677368, 0.022094727, 0.033691406, -0.041259766, 0.004180908, -0.056152344, 
0.005859375, -0.030517578, 0.015197754, 0.045410156, 0.022705078, 0.018554688, -0.04711914, -0.015136719, 0.061523438, -0.025024414, 
-0.052246094, 0.018066406, 0.036621094, 0.000854492, 0.029541016, -0.037841797, 0.015380859, 0.027709961, 0.05102539, -0.015991211, 
-0.044189453, -0.004333496, -0.007568359, 0.03515625, 0.026123047, -0.013000488, -0.034423828, 0.03515625, 0.01928711, 0.022583008, 
-0.035888672, 0.04321289, -0.017333984, 0.017211914, 0.005859375, -0.039794922, -0.009155273, -0.021118164, 0.008789062, 0.025634766, 
0.033203125, 0.025512695, -0.007019043, 0.00189209, -0.00769043, 0.012878418, -0.012634277, -0.01385498, 0.031982422, -0.037597656, 
0.005523682, 0.010314941, -0.023925781, -0.03112793, 0.018798828, -0.003799438, 0.015197754, 0.045410156, -0.020385742, -0.001602173, 
-0.006408691, -0.033935547, 0.012878418, -0.012207031, 0.03112793, 0.005096436, -0.010437012, 0.010437012, -0.025756836, 0.015197754, 
0.028198242, -0.000293732, -0.026000977, 0.00352478, 0.005950928, -0.022705078, -0.015563965, -0.041259766, -0.012084961, 
-0.022705078, -5.7459e-05, -0.001335144, -0.028930664, 0.056396484, 0.03515625, 0.036621094, 0.00994873, 0.053222656, 0.004394531, 
-0.017578125, -0.01928711, -0.045898438, -0.021606445, -0.017578125, -0.004974365, -0.009155273, 0.008544922, 0.033203125, 
0.025268555, 0.013916016, -0.004852295, -0.04321289, -0.012817383, -0.010559082, -0.0234375, 0.039794922, -0.026977539, 0.01574707, 
-0.00680542, 0.033447266, 0.034179688, -0.002487183, 0.003570557, -0.034179688, 0.0703125, 0.03930664, 0.001686096, 0.008728027, 
0.029541016, 0.029541016, 0.07080078, 0.018310547, -0.011779785, -0.041748047, -0.011962891, -0.010253906, 0.01586914, -0.045410156, 
-0.000473022, -0.023071289, 0.048339844, -0.04711914, -0.05493164, -0.034179688, 0.000499725, 0.03125, 0.017211914, -0.02355957, 
-0.05883789, 0.014770508, -0.018920898, -0.007415771, 0.03466797, -0.024414062, -0.011352539, -0.014099121, 0.03112793, 0.056152344, 
-0.04663086, 0.018554688, 0.01361084]

def download_image_from_url(url: str, save_dir: str = "images_from_url") -> str:
    """
    Downloads an image from the specified URL and saves it to the given directory.
    Uses the file name as given in the URL.
    Returns the path to the saved image file.
    """
    os.makedirs(save_dir, exist_ok=True)
    parsed = urlparse(url)
    file_name = os.path.basename(parsed.path)
    image_path = os.path.join(save_dir, file_name)
    response = requests.get(url, stream=True)
    response.raise_for_status()
    with open(image_path, "wb") as f:
        for chunk in response.iter_content(1024):
            f.write(chunk)
    return image_path 



def segment_image(image_url: str):
    """
    Downloads image from URL, segments it, and generates embeddings for each segment.
    
    Returns:
        List of embeddings (one for each segment)
    """
    downloaded_path = download_image_from_url(image_url)
    result = sam3_segment_image(downloaded_path)
    saved_paths = process_segments_and_save(result, downloaded_path)
    print(f"Saved {len(saved_paths)} segment images:")
    for path in saved_paths:
        print(f"  - {path}")
    embeddings = embed_segment_images(saved_paths)
    print(f"Generated {len(embeddings)} embeddings, each with {len(embeddings[0]) if embeddings else 0} dimensions")
    return embeddings


connection_pool = None


def get_connection_pool():
    global connection_pool
    if connection_pool is None:
        USER = os.getenv("user")
        PASSWORD = os.getenv("password")
        HOST = os.getenv("host")
        PORT = os.getenv("port")
        DBNAME = os.getenv("dbname")
        
        connection_pool = pool.ThreadedConnectionPool(
            minconn=2,
            maxconn=76,
            user=USER,
            password=PASSWORD,
            host=HOST,
            port=PORT,
            dbname=DBNAME
        )
        print(f"Connection pool initialized: minconn=2, maxconn=76")
    return connection_pool


@asynccontextmanager
async def lifespan(app: FastAPI):
    get_connection_pool()
    yield
    if connection_pool:
        connection_pool.closeall()
        print("Connection pool closed")


app = FastAPI(
    title="SAM3 Segmentation & Vector Search API",
    description="API for image segmentation and vector similarity search",
    version="1.0.0",
    lifespan=lifespan
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


class SearchRequest(BaseModel):
    query_embedding: List[float]
    limit: Optional[int] = 10
    similarity_threshold: Optional[float] = 0.7
    application: Optional[str] = None
    region_served: Optional[List[str]] = None
    relative_price: Optional[int] = None
    sustainability_and_health: Optional[List[str]] = None


class ImageSearchRequest(BaseModel):
    image_url: str
    limit: Optional[int] = 10
    similarity_threshold: Optional[float] = 0.7
    application: Optional[str] = None
    region_served: Optional[List[str]] = None
    relative_price: Optional[int] = None
    sustainability_and_health: Optional[List[str]] = None


class SearchResponse(BaseModel):
    count: int
    results: List[dict]


class ImageSearchResponse(BaseModel):
    segments_processed: int
    segment_results: List[dict]


@app.get("/")
async def root():
    return {"message": "SAM3 Segmentation & Vector Search API", "status": "running"}


@app.post("/search/voyage", response_model=SearchResponse)
async def search_voyage_embedding(request: SearchRequest):
    """
    Search for similar products using a Voyage embedding vector.
    
    Uses the connection pool for optimal performance.
    """
    try:
        results = search_by_voyage_embedding(
            query_embedding=request.query_embedding,
            limit=request.limit,
            similarity_threshold=request.similarity_threshold,
            application=request.application,
            region_served=request.region_served,
            relative_price=request.relative_price,
            sustainability_and_health=request.sustainability_and_health
        )
        return SearchResponse(count=len(results), results=results)
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/search/image", response_model=ImageSearchResponse)
async def search_by_image_url(request: ImageSearchRequest):
    """
    Search for similar products by processing an image URL.
    
    Flow:
    1. Download image from URL
    2. Segment the image using SAM3
    3. Generate Voyage embeddings for each segment
    4. Search for similar products using each embedding
    5. Return results for all segments
    """
    try:
        embeddings = segment_image(request.image_url)
        
        if not embeddings:
            raise HTTPException(status_code=400, detail="No segments found in image")
        
        segment_results = []
        for idx, embedding in enumerate(embeddings):
            results = search_by_voyage_embedding(
                query_embedding=embedding,
                limit=request.limit,
                similarity_threshold=request.similarity_threshold,
                application=request.application,
                region_served=request.region_served,
                relative_price=request.relative_price,
                sustainability_and_health=request.sustainability_and_health
            )
            segment_results.append({
                "segment_index": idx,
                "embedding_dimensions": len(embedding),
                "count": len(results),
                "results": results
            })
        
        return ImageSearchResponse(
            segments_processed=len(embeddings),
            segment_results=segment_results
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/search/voyage/test")
async def test_search():
    """
    Test endpoint using the mock embedding from this file.
    """
    try:
        results = search_by_voyage_embedding(
            query_embedding=mock_embedding,
            limit=10,
            similarity_threshold=0.7
        )
        return {
            "message": "Test search successful",
            "embedding_dimensions": len(mock_embedding),
            "count": len(results),
            "results": results
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8001)

