import os
from io import BytesIO

import torch
from transformers import AutoImageProcessor, AutoModel
from PIL import Image
import requests

MODEL_ID = "facebook/dinov2-small"  # 384-dim embeddings


def get_device() -> torch.device:
    """Select best available device (MPS > CUDA > CPU)."""
    if torch.backends.mps.is_available():
        return torch.device("mps")
    if torch.cuda.is_available():
        return torch.device("cuda")
    return torch.device("cpu")


def load_model(model_id: str = MODEL_ID, device: torch.device | None = None):
    """Load processor and model, move model to device."""
    if device is None:
        device = get_device()
    print("Using device:", device)

    processor = AutoImageProcessor.from_pretrained(model_id)
    model = AutoModel.from_pretrained(model_id).to(device)
    model.eval()
    return processor, model, device


def load_image(path_or_url: str) -> Image.Image:
    """Load image from local path or URL as RGB PIL image."""
    if path_or_url.startswith("http://") or path_or_url.startswith("https://"):
        resp = requests.get(path_or_url, timeout=10)
        resp.raise_for_status()
        img = Image.open(BytesIO(resp.content)).convert("RGB")
    else:
        img = Image.open(path_or_url).convert("RGB")
    return img


def embed_images(
    image_list: list[Image.Image],
    processor: AutoImageProcessor,
    model: AutoModel,
    device: torch.device,
) -> list[list[float]]:
    """
    image_list: list[PIL.Image.Image]
    returns: list[list[float]]  # each 384-d
    """
    inputs = processor(images=image_list, return_tensors="pt").to(device)

    with torch.no_grad():
        outputs = model(**inputs)  # last_hidden_state: [B, N, D]

    # CLS token embedding: shape [B, D], D=384 for dinov2-small
    feats = outputs.last_hidden_state[:, 0, :]
    # L2-normalize for cosine similarity
    feats = torch.nn.functional.normalize(feats, dim=-1)
    return feats.cpu().tolist()


def main() -> list[float]:
    """
    Main entrypoint:
    - Uses hard-coded image path
    - Returns a single 384-d embedding vector
    """
    image_path = "kitchen-calacatta-themis-01-v6.jpg"
    if not os.path.exists(image_path):
        raise FileNotFoundError(f"Image not found at {image_path}")

    processor, model, device = load_model(MODEL_ID)
    pil_img = load_image(image_path)
    embeddings = embed_images([pil_img], processor, model, device)

    embedding = embeddings[0]
    print("Got 1 embedding")
    print("Dim of embedding:", len(embedding))
    # Print the full embedding vector so it's visible in terminal output
    print("Embedding vector:", embedding)
    return embedding


if __name__ == "__main__":
    main()



# Embedding vector: [-0.14829552173614502, 0.03279751539230347, -0.014114534482359886, -0.04136914387345314, 0.05731073021888733, -0.009071988053619862, -0.04047498106956482, -0.019835835322737694, 0.03546353802084923, 0.043065641075372696, 0.027445906773209572, -0.0953688994050026, 0.07495192438364029, -0.14275473356246948, -0.06290505081415176, -0.026448864489793777, 0.07092498987913132, 0.08368019014596939, 0.04130910336971283, -0.07202374190092087, 0.018041828647255898, -0.027602313086390495, 0.06884729117155075, -0.012760802172124386, 0.005740802269428968, 0.00021122125326655805, -0.008477454073727131, -0.01358055230230093, 0.031400781124830246, -0.1266951858997345, -0.07391683757305145, 0.06755749136209488, -0.0367419458925724, 0.08067536354064941, -0.01511425618082285, 0.012966384179890156, -0.044302426278591156, -0.02456158585846424, 0.04787193611264229, 0.10311570763587952, 0.04553123936057091, 0.03644220530986786, 0.007903862744569778, -0.055946387350559235, -0.02207990549504757, 0.005441922228783369, 0.008562801405787468, -0.02180759236216545, 0.08822757005691528, -0.0032513579353690147, -0.002614589175209403, -0.006996192969381809, -0.011854804120957851, -0.0052620647475123405, 0.037537649273872375, -0.04484538361430168, -0.0792412981390953, 0.09468317031860352, 0.0033991821110248566, -0.020294809713959694, 0.07797898352146149, -0.03511865809559822, 0.04457709938287735, 0.03735997527837753, -0.01718585193157196, 0.029434403404593468, 0.052519191056489944, 0.002900772960856557, 0.026367072016000748, 0.049812640994787216, 0.07259158045053482, 0.02879176288843155, -0.009668895043432713, 0.050385188311338425, -0.04196152091026306, -0.08810306340456009, 0.06502559781074524, 0.08144626766443253, 0.00941375270485878, -0.03810299187898636, 0.0007390528917312622, -0.03214425593614578, -0.05852249264717102, 0.017841946333646774, 0.03177778422832489, -0.08894530683755875, 0.04794659838080406, -0.014450770802795887, 0.06477408856153488, -0.005956787616014481, -0.0008441234822385013, -0.031067630276083946, -0.043442390859127045, -0.10369397699832916, -0.0019743777811527252, -0.030401894822716713, 0.022203564643859863, -0.0246559027582407, -0.041567232459783554, -0.018666110932826996, -0.06374655663967133, 0.024111628532409668, -0.03887385502457619, 0.01833818294107914, -0.07952478528022766, 0.028017651289701462, -0.005288669373840094, -0.11275451630353928, 0.08129020035266876, 0.08384393155574799, -0.019780421629548073, -0.024508286267518997, 0.015003371983766556, 0.04264414310455322, 0.039671026170253754, -0.02156081236898899, 0.013449559919536114, -0.018171869218349457, 0.028815586119890213, -0.011732661165297031, 0.006027847994118929, 0.05388481169939041, 0.11758242547512054, 0.03277178853750229, -0.03167885169386864, -0.0072001866064965725, -0.011527330614626408, -0.018573079258203506, 0.004868078511208296, 0.11626891791820526, 0.008496349677443504, 0.11895274370908737, -0.031373873353004456, 0.015287681482732296, 0.0004108070570509881, 0.04752129688858986, -0.10185452550649643, -0.08313983678817749, -0.005935300141572952, 0.05638798698782921, 0.07009860873222351, 0.07716857641935349, -0.0009379410184919834, -0.05931977555155754, -0.05159374698996544, -0.025148266926407814, -0.025975503027439117, -0.020474500954151154, 0.028903193771839142, -0.0036933342926204205, 0.0025090069975703955, -0.05370377376675606, 0.0058926790952682495, -0.04795670509338379, -0.13715097308158875, -0.02606535144150257, -0.05140634626150131, 0.02793164923787117, 0.03705960139632225, 0.0004731294175144285, 0.056358449161052704, 0.022088496014475822, -0.02019280567765236, 0.019264288246631622, 0.01071249134838581, 0.01718257926404476, -0.008007385767996311, -0.00516198156401515, -0.03134475648403168, 0.00826965644955635, -0.009958852082490921, -0.055452533066272736, 0.07917959988117218, 0.08561984449625015, -0.01421349961310625, -0.053758539259433746, -0.0009290120215155184, 0.05541063845157623, -0.016058478504419327, -0.022390753030776978, -0.03400902450084686, 0.06258467584848404, 0.08104350417852402, -0.0005388493300415576, 0.06308098882436752, 0.07763393223285675, -0.004183492157608271, -0.02872983179986477, -0.027557356283068657, -0.08015763014554977, -0.06450001895427704, 0.009516837075352669, 0.027438754215836525, -0.009143456816673279, 0.03409016504883766, -0.04301447793841362, 0.019773133099079132, -0.023916885256767273, 0.037491604685783386, -0.06221317872405052, -0.0866365134716034, -0.06645282357931137, -0.03842173516750336, 0.012293539009988308, -0.047688912600278854, 0.04435732960700989, -0.03474653512239456, -0.14662516117095947, -0.08370598405599594, -0.025095229968428612, 0.06609131395816803, -0.0805630087852478, -0.0437232181429863, 0.01269763894379139, -0.0675276592373848, -0.013272903859615326, -0.026009483262896538, 0.001814858173020184, 0.008534465916454792, 0.059562839567661285, -0.06692460924386978, -0.11063382774591446, -0.04908524826169014, 0.02006201632320881, -0.01873883232474327, -0.017709823325276375, 0.05921095609664917, -0.014113676734268665, -0.030302168801426888, -0.06315717846155167, 0.05305912345647812, -0.025416359305381775, 0.06624004989862442, 0.031776923686265945, 0.032600730657577515, 0.018455220386385918, -0.03757035359740257, -0.06731311231851578, -0.01812559738755226, 0.026581700891256332, -0.014027146622538567, 0.021724557504057884, 0.006553126964718103, -0.006067976355552673, 0.05280499532818794, -0.012082581408321857, 0.05988423153758049, 0.012920706532895565, -0.024588316679000854, 0.1158563569188118, 0.020970264449715614, 0.014983014203608036, 0.008935581892728806, 0.0027626852970570326, -0.0683102086186409, -0.014239919371902943, 0.0029937843792140484, 0.06699616461992264, 0.050883471965789795, -0.015209943056106567, 0.023990755900740623, 0.0021164941135793924, -0.006694454699754715, -0.07543250173330307, -0.024145465344190598, -0.043105822056531906, 0.025547007098793983, 0.026273157447576523, 0.006581114139407873, -0.01926415041089058, -0.029164766892790794, -0.004519759211689234, 0.06478652358055115, 0.06914031505584717, -0.015805242583155632, 0.0205630324780941, 0.045324377715587616, 0.02072381041944027, -0.01364312507212162, -0.0106807304546237, -0.04189920797944069, 0.056655317544937134, -0.008115489035844803, -0.0431206189095974, 0.07284846901893616, 0.02761300466954708, 0.009488332085311413, -0.027373850345611572, 0.08486252278089523, -0.10566264390945435, 0.028067631646990776, -0.03703579679131508, -0.06426170468330383, 0.046171270310878754, -0.02947845309972763, 0.06730730831623077, -0.01841423101723194, 0.009769443422555923, 0.011600075289607048, 0.08328583091497421, -0.03087599389255047, 0.0942903384566307, 0.005681321956217289, -0.025742771103978157, 0.06400499492883682, 0.07104519754648209, 0.01987404003739357, -0.006347899790853262, 0.07909255474805832, 0.046763788908720016, -0.07881471514701843, 0.01620226539671421, 0.003939278889447451, -0.03202526271343231, -0.02155480533838272, -0.08172184228897095, 0.13163071870803833, 0.024313870817422867, 0.024955347180366516, -0.0278940349817276, -0.06484425812959671, -0.019852863624691963, -0.08657026290893555, 0.021338853985071182, -0.07991292327642441, -0.005347594153136015, 0.036226049065589905, 0.031826816499233246, -0.045705221593379974, 0.02853507734835148, -0.042861208319664, 0.008570544421672821, 0.07704203575849533, -0.04366624727845192, 0.020966054871678352, -0.05650361254811287, 0.14370743930339813, -0.025933967903256416, 0.0008582118898630142, 0.021796222776174545, 0.016802795231342316, -0.04365454241633415, 0.031972452998161316, -0.10409589111804962, 0.08335462957620621, 0.00044462078949436545, -0.019719718024134636, -0.07650072127580643, 0.07941284775733948, 0.055861420929431915, -0.024607915431261063, 0.030633695423603058, -0.0005995575338602066, 0.054732583463191986, -0.12386683374643326, -0.10895221680402756, 0.0002887436421588063, -0.03075638972222805, 0.07548442482948303, 0.011979009956121445, -0.09208860248327255, -0.008131473325192928, -0.025271523743867874, -0.005182813853025436, -0.03654187545180321, 0.07961311936378479, -0.06119415536522865, -0.017138496041297913, 0.04332530498504639, 0.017589427530765533, -0.07479827105998993, 0.10247671604156494, -0.0032529495656490326, 0.02909129671752453, 0.0790582001209259, 0.001161229913122952, 0.04079755023121834, 0.006492166314274073, 0.06325990706682205, 0.01664786972105503, 0.0879782885313034, -0.04522722214460373, -0.028151702135801315, -0.01644231006503105]